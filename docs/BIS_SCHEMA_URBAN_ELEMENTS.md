# BIS Schema for Urban Elements - Chancay Digital Twin

This document defines the Building Information Schema (BIS) class structure used for urban elements in the Chancay Digital Twin, following iTwin.js best practices and avoiding JsonProperties.

## Overview

The urban digital twin uses proper BIS classes for all geometric and semantic elements, ensuring type safety, performance, and standards compliance.

## Building Elements

### Primary Classes

#### CGA-Generated Buildings
```typescript
classFullName: "Generic:GenericPhysicalObject"
category: "Building" // Category.CodeValue
```

Generated by the CGA-lite rules engine, these represent procedurally created urban buildings with proper geometric streams.

#### Schema-Based Buildings (Alternative)
```typescript
classFullName: "bis.Building" 
// For iModels with dedicated urban schema
```

### Geometric Properties (Native BIS)

All measurements use native BIS properties, **not JsonProperties**:

#### Height Calculation
```sql
-- From bounding box (most accurate)
height = bb.High.Z - bb.Low.Z

-- Query example
SELECT COALESCE(bb.High.Z - bb.Low.Z, 25.0) as height
FROM BisCore.PhysicalElement e
LEFT JOIN BisCore.ElementAspect bb ON e.ECInstanceId = bb.Element.Id
```

#### Volume & Area
```sql
-- Native geometric properties
volume = g.Volume                    -- m³ (native BIS)
footprintArea = g.Surface           -- m² (native BIS)
floorArea = g.Volume / height       -- Calculated from volume

-- Query example  
SELECT 
  COALESCE(g.Volume, 0) as volume,
  COALESCE(g.Surface, 0) as footprintArea,
  COALESCE(g.Volume / NULLIF(bb.High.Z - bb.Low.Z, 0), g.Surface * 3.5) as floorArea
FROM BisCore.GeometricElement3d g
```

## Spatial Organization

### Urban Hierarchy
```
Project (iModel)
├── Block (SpatialLocationElement)
│   ├── Lot (SpatialLocationElement) 
│   │   ├── Building (PhysicalElement)
│   │   ├── Landscape (PhysicalElement)
│   │   └── Infrastructure (PhysicalElement)
│   └── ...
└── ...
```

### BIS Implementation
```sql
-- Blocks: Top-level spatial containers
SELECT s.UserLabel as blockId
FROM BisCore.SpatialLocationElement s  
WHERE s.Parent.Id = [ProjectRootId]

-- Lots: Children of blocks
SELECT lot.UserLabel as lotId, block.UserLabel as blockId
FROM BisCore.SpatialLocationElement lot
JOIN BisCore.SpatialLocationElement block ON block.ECInstanceId = lot.Parent.Id

-- Buildings: Children of lots
SELECT e.ECInstanceId, lot.UserLabel as lotId
FROM BisCore.PhysicalElement e
JOIN BisCore.SpatialLocationElement lot ON lot.ECInstanceId = e.Parent.Id
```

## Categories

### Standard Categories
```sql
-- Buildings
c.CodeValue = 'Building'

-- Landscape elements
c.CodeValue = 'Landscape' 

-- Infrastructure
c.CodeValue = 'Infrastructure'
```

### Category-Based Queries
```sql
-- Get all buildings in a project
SELECT e.*, c.CodeValue as category
FROM BisCore.PhysicalElement e
JOIN BisCore.Category c ON e.Category.Id = c.ECInstanceId  
WHERE c.CodeValue = 'Building'
```

## Production ECSQL Queries

### Urban KPI Calculations

#### Overall Metrics
```sql
SELECT 
  COUNT(*) as buildingCount,
  AVG(bb.High.Z - bb.Low.Z) as avgHeight,
  MAX(bb.High.Z - bb.Low.Z) as maxHeight,
  SUM(g.Volume) as totalVolume,
  SUM(g.Surface) as totalFootprint
FROM BisCore.PhysicalElement e
JOIN BisCore.Category c ON e.Category.Id = c.ECInstanceId  
JOIN BisCore.GeometricElement3d g ON e.ECInstanceId = g.ECInstanceId
LEFT JOIN BisCore.ElementAspect bb ON e.ECInstanceId = bb.Element.Id
WHERE c.CodeValue = 'Building'
  AND g.Volume IS NOT NULL
```

#### Block-Level Metrics
```sql
SELECT 
  spatial.UserLabel as blockId,
  COUNT(*) as buildingCount,
  AVG(bb.High.Z - bb.Low.Z) as avgHeight,
  SUM(g.Volume) as blockVolume
FROM BisCore.PhysicalElement e
JOIN BisCore.Category c ON e.Category.Id = c.ECInstanceId
JOIN BisCore.GeometricElement3d g ON e.ECInstanceId = g.ECInstanceId
LEFT JOIN BisCore.ElementAspect bb ON e.ECInstanceId = bb.Element.Id
JOIN BisCore.SpatialLocationElement spatial ON spatial.ECInstanceId = e.Parent.Id
WHERE c.CodeValue = 'Building'
GROUP BY spatial.UserLabel
```

#### Lot Analysis
```sql
SELECT 
  lot.UserLabel as lotId,
  block.UserLabel as blockId,
  lot_geom.Surface as siteArea,
  COALESCE(green.area, 0) as greenSpaceArea,
  COALESCE(built.area, 0) as builtArea
FROM BisCore.SpatialLocationElement lot
JOIN BisCore.SpatialLocationElement block ON block.ECInstanceId = lot.Parent.Id
LEFT JOIN BisCore.GeometricElement3d lot_geom ON lot.ECInstanceId = lot_geom.ECInstanceId
LEFT JOIN (
  SELECT Parent.Id as LotId, SUM(g.Surface) as area
  FROM BisCore.PhysicalElement e
  JOIN BisCore.Category c ON c.Id = e.Category.Id
  JOIN BisCore.GeometricElement3d g ON g.ECInstanceId = e.ECInstanceId
  WHERE c.CodeValue = 'Landscape'
  GROUP BY Parent.Id
) green ON green.LotId = lot.ECInstanceId
LEFT JOIN (
  SELECT Parent.Id as LotId, SUM(g.Surface) as area
  FROM BisCore.PhysicalElement e  
  JOIN BisCore.Category c ON c.Id = e.Category.Id
  JOIN BisCore.GeometricElement3d g ON g.ECInstanceId = e.ECInstanceId
  WHERE c.CodeValue = 'Building'
  GROUP BY Parent.Id
) built ON built.LotId = lot.ECInstanceId
```

## Benefits vs JsonProperties

### Performance
- **Native queries**: No JSON parsing overhead
- **Indexed properties**: BIS properties are properly indexed
- **Type safety**: Compile-time validation vs runtime JSON errors

### Standards Compliance  
- **BIS specification**: Follows official iTwin.js patterns
- **Interoperability**: Works with other iTwin.js applications
- **Future-proof**: Compatible with schema evolution

### Query Optimization
- **Query planner**: Database can optimize native property access
- **Memory usage**: Reduced memory footprint vs JSON extraction
- **Caching**: Better query result caching

## Chancay-Specific Implementation

For the Chancay Digital Twin, this schema supports:

- **UTM 18S coordinates**: All geometric elements in EPSG:32718/5387
- **Peruvian building codes**: Height limits, setbacks, FAR calculations  
- **Block-based planning**: Manzana organization typical in Lima urban planning
- **Mixed-use development**: Residential, commercial, infrastructure categories

## References

- [iTwin.js ECSQL Documentation](https://www.itwinjs.org/learning/ecsql/)
- [BIS Core Schema Reference](https://www.itwinjs.org/bis/domains/bis-core/)
- [Useful ECSQL Queries](https://www.itwinjs.org/learning/backend/accessingimodels/#useful-ecsql-queries)
- [Creating Elements](https://www.itwinjs.org/learning/backend/createelements/)